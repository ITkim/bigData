(function(_,Backbone,koreanair,ServiceApi,Booking,Templates,I18n){var AuthenticationMethodView=koreanair.View.extend({el:".registrationWrapper",events:{"change #allchecked":"allCheck","change .agree-box [type\x3dcheckbox]":"setAllCheck"},template:Templates["authentication-method"],className:".authentication-method",render:function(){var html=this.template();this.$el.html(html);this.setAgrees();this.setAllCheck();$(".btn-certification").die("click").live("click",_.bind(this.openAuth,this));$("#mobile-auth-button").die("click").live("click",
_.bind(this.openAuth,this));koreanair.analytics.track("register_step1");if(typeof TLT!="undefined"&&TLT!=null)if(TLT&&TLT.isInitialized()&&TLT.getModuleConfig("replay").domCapture.enabled)TLT.logScreenviewLoad("#step1-1-selectAuth")},initialize:function(){},setAllCheck:function(){if($(".agree-box input:checkbox:not(:checked)").length>0)$("#allchecked").prop("checked",false);else $("#allchecked").prop("checked",true);var params={member:$("#memberagree").prop("checked"),privacy:$("#privacyagree").prop("checked"),
vendor:$("#vendoragree").prop("checked"),marketing:$("#marketingagree").prop("checked")};koreanair.utils.setSessionStorage(JSON.stringify(params),"enrollAgree")},allCheck:function(e){if($(e.currentTarget).prop("checked"))$(".agree-box [type\x3dcheckbox]").prop("checked",true);else $(".agree-box [type\x3dcheckbox]").prop("checked",false);this.setAllCheck()},openAuth:function(e){e.preventDefault();if($("#memberagree").prop("checked")&&$("#privacyagree").prop("checked")&&$("#relocateagree").prop("checked"))if(koreanair.isMobile)this.triggerMOBILE();
else if($(e.currentTarget).is(".phone"))this.triggerMOBILE();else this.triggerIPIN();else this.alertAgree()},alertAgree:function(){var opts={onClosed:function(){if(!$("#memberagree").prop("checked"))$("#memberagree").focus();else if(!$("#privacyagree").prop("checked"))$("#privacyagree").focus();else $("#relocateagree").focus()},returnFocus:false};koreanair.RegistrationAlert.alertModal(I18n.get("agree-before-registration"),opts)},triggerIPIN:function(){koreanair.registration.isGuardianAuth=false;koreanair.ipinAuthentication("SU")},
triggerMOBILE:function(){koreanair.registration.isGuardianAuth=false;koreanair.mobileAuthentication("SU")},setAgrees:function(){if(!koreanair.isMobile){var urlPath=_.initial($(koreanair.registrationLinks.content.termsofuse).find("a").attr("href").split("/")).join("/");var agrees=["terms-of-use","privacy-policy","privacy-international-transmission","3rd-party-vendor-policy","marketing-advertising-agreement"];for(var i in agrees){var agreeUrl=urlPath+"/"+agrees[i]+"/jcr%3Acontent/par/text.json";(function(i){i*=
1;$.ajax({url:agreeUrl,dataType:"html",success:function(d){$("#agree"+(i+1)).siblings(".scrollbox").html(JSON.parse(d).text)}})})(i)}}}});koreanair.AuthenticationMethodView=AuthenticationMethodView})(_,Backbone,koreanair,koreanair.ServiceApi,koreanair.Booking,Handlebars.templates,Granite.I18n);
(function(_,Backbone,koreanair,ServiceApi,Booking,Templates,i18n){var GuardianFormView=koreanair.View.extend({template:Templates["guardian-form"],className:"guardian-form",events:{"click #ipin-auth":"triggerIPIN","click #mobile-auth":"triggerMOBILE"},render:function(){this.$el.html(this.template());koreanair.analytics.track("register_step2");if(typeof TLT!="undefined"&&TLT!=null)if(TLT&&TLT.isInitialized()&&TLT.getModuleConfig("replay").domCapture.enabled)TLT.logScreenviewLoad("#step1-2-guardianAuth");
return this},initialize:function(){},isValidForm:function(){var $form=$("#registration-form");$form.validate({rules:{"guardianEmail":{"email":true},"email":{"email":true},"guardian-confirm":{required:true}},messages:{"guardianEmail":{email:i18n.get("invalid-email")},"email":{"email":i18n.get("invalid-email")},"guardian-confirm":{required:i18n.get("info-required")}},errorPlacement:function(error,element){if(element.attr("type")==="checkbox"){$(element).parent("div").append(error);return}error.insertAfter(element)},
"invalidHandler":function(form,validator){var errors=validator.numberOfInvalids();if(errors)validator.errorList[0].element.focus()}});return $form.valid()},getGuardianInfo:function(){return{memberRelationName:$("#guardianRelationship").val(),guardianEmailAddress:$("#guardianEmail").val()}},triggerIPIN:function(e){e.preventDefault();if(!this.isValidForm())return;koreanair.registration.isGuardianAuth=true;koreanair.registration.guardianInfo=this.getGuardianInfo();koreanair.ipinAuthentication("register")},
triggerMOBILE:function(e){e.preventDefault();if(!this.isValidForm())return;koreanair.registration.isGuardianAuth=true;koreanair.registration.guardianInfo=this.getGuardianInfo();koreanair.mobileAuthentication("register")}});koreanair.GuardianFormView=GuardianFormView})(_,Backbone,koreanair,koreanair.ServiceApi,koreanair.Booking,Handlebars.templates,Granite.I18n);
(function(_,Backbone,koreanair,ServiceApi,Booking,Templates,I18n){var RegistrationLandingView=koreanair.View.extend({el:".registrationWrapper",events:{"click .newMember":"createNewMember","click .existing":"showRegistrationForm"},template:Templates["ke-registration-landing"],existingMember:true,render:function(){var html=this.template();koreanair.analytics.track("register_step1");this.$el.html(html);if(typeof TLT!="undefined"&&TLT!=null)if(TLT&&TLT.isInitialized()&&TLT.getModuleConfig("replay").domCapture.enabled)TLT.logScreenviewLoad("#step1-1-selectOldNew")},
initialize:function(){window.location="#authenticate"},validateLandingForm:function(){var $form=$(".existing-member form");$.validator.addClassRules("required",{required:true});$.validator.addMethod("alphaNumeric",function(value,element){return this.optional(element)||/^[a-zA-Z0-9]+$/i.test(value)},"SKYPASS # must contain only letters and numbers.");$.validator.addMethod("accept",function(value,element,param){return value.match(new RegExp("^"+param+"$"))});$form.validate({"rules":{skypassNumber:{"required":true,
"alphaNumeric":true,"rangelength":[9,12]},dateOfBirthDay:{required:true,digits:true,rangelength:[1,2],range:[1,12]},dateOfBirthMonth:{required:true,digits:true,rangelength:[1,2],range:[1,31]},dateOfBirthYear:{required:true,digits:true,rangelength:[4,4],range:[1900,Number(moment().format("YYYY"))]}},"messages":{skypassNumber:{alphaNumeric:"Please only enter letters or numbers",required:"SKYPASS # is required",rangelength:"Skypass number should be 10 to 11 numbers and letters"},firstName:{required:"First name is required"},
lastName:{required:"Last name is required"},koreanFirstName:{required:"Korean first name is required"},koreanLastName:{required:"Korean last name is required"},dateOfBirthDay:{required:I18n.get("required-error"),digits:I18n.get("only-numbers-error"),rangelength:I18n.get("invalid-month"),range:I18n.get("invalid-month")},dateOfBirthMonth:{required:I18n.get("required-error"),digits:I18n.get("only-numbers-error"),rangelength:I18n.get("invalid-day"),range:I18n.get("invalid-day")},dateOfBirthYear:{required:I18n.get("required-error"),
digits:I18n.get("only-numbers-error"),rangelength:I18n.get("invalid-year"),range:I18n.get("invalid-year")}},"invalidHandler":function(form,validator){var errors=validator.numberOfInvalids();if(errors)validator.errorList[0].element.focus()}});return $form.valid()},showRegistrationForm:function(){if(this.existingMember)if(this.validateLandingForm()){var formData=this.options.wrapper.find("form").serializeObject();this.loading=this.verifyUser(formData);this.$el.find(".loading-bar").fadeIn();this.loading.done(_.bind(this.validateUserData,
this));this.loading.fail(_.bind(this.userError,this))}else return false;else this.renderRegistrationForm()},verifyUser:function(userData){userData.dateOfBirth=moment(userData.dateOfBirth).format("YYYY-MM-DD");return ServiceApi.skypassInternetMember.post({data:JSON.stringify(userData)})},validateUserData:function(data){var dobError=_.isEmpty(data);var isNewEnrollment=_.isEmpty(data.userId);if(!dobError&&isNewEnrollment)this.renderRegistrationForm();else this.userError()},renderRegistrationForm:function(){this.$el.find(".loading-bar").fadeOut();
var formData=this.options.wrapper.find("form").serializeObject();formData.existingMember=this.existingMember;formData.language="ko-kr";var RegistrationModel=Backbone.Model.extend({defaults:formData});var registrationModelInstance=new RegistrationModel;this.registrationForm=new koreanair.RegistrationFormView({model:registrationModelInstance,wrapper:this.options.wrapper});this.registrationForm.render();koreanair.router.switchViewHTML(this.registrationForm);koreanair.CustomForms.render();koreanair.router.renderDOBFields()},
userError:function(){this.$el.find(".loading-bar").fadeOut();this.$el.find("div.error").fadeIn()}});koreanair.RegistrationLandingView=RegistrationLandingView})(_,Backbone,koreanair,koreanair.ServiceApi,koreanair.Booking,Handlebars.templates,Granite.I18n);
(function(_,Backbone,koreanair,ServiceApi,Booking,Templates,i18n,legalPopups){var countryPhonList={KR:"82",US:"1",JP:"81",CN:"86",AF:"93",AL:"355",DZ:"213",AS:"1684",AD:"376",AO:"244",AI:"1264",AG:"1268",AR:"54",AM:"374",AW:"297",AU:"61",AT:"43",AZ:"994",BS:"1242",BH:"973",BD:"880",BB:"1246",BY:"375",BE:"32",BZ:"501",BJ:"229",BM:"1441",BT:"975",BO:"591",BA:"387",BW:"267",BR:"55",BN:"673",BG:"359",BF:"226",BI:"257",KH:"855",CM:"237",CA:"1",CV:"238",KY:"1345",CF:"236",TD:"235",CL:"56",CN:"86",CC:"672",
CO:"57",KM:"269",CG:"242",CS:"243",CK:"682",CR:"506",CI:"225",HR:"385",CU:"53",CY:"357",CZ:"420",DK:"45",DJ:"253",DM:"1767",DO:"1809",EC:"593",EG:"20",SV:"503",GQ:"240",ER:"291",EE:"372",ET:"251",FK:"500",FO:"298",FJ:"679",FI:"358",FR:"33",GF:"594",PF:"689",GA:"241",GM:"220",GE:"995",DE:"49",GH:"233",GI:"350",GR:"30",GL:"299",GD:"1473",GP:"590",GU:"1671",GT:"502",GN:"224",GW:"245",GY:"592",HT:"509",HN:"504",HK:"852",HU:"36",IS:"354",IN:"91",ID:"62",IR:"98",IQ:"964",IE:"353",IL:"972",IT:"39",JM:"1876",
JP:"81",JO:"962",KZ:"7",KE:"254",KI:"686",KR:"82",KW:"965",KG:"996",LA:"856",LV:"371",LB:"961",LS:"266",LR:"231",LY:"218",LI:"423",LT:"370",LU:"352",MO:"853",MK:"389",MG:"261",MW:"265",MY:"60",MV:"960",ML:"223",MT:"356",MH:"692",MQ:"596",MR:"222",MU:"230",MX:"52",FM:"691",MD:"373",MC:"377",MN:"976",ME:"382",MS:"1664",MA:"212",MZ:"258",MM:"95",NA:"264",NR:"674",NP:"977",NL:"31",NC:"687",NZ:"64",NI:"505",NE:"227",NG:"234",NU:"683",MP:"1670",NO:"47",OM:"968",PK:"92",PW:"680",PS:"970",PA:"507",PG:"675",
PY:"595",PE:"51",PH:"63",PL:"48",PT:"351",PR:"1",QA:"974",RE:"262",RO:"40",RU:"7",RW:"250",SH:"290",KN:"1869",LC:"1758",PM:"508",VC:"1784",WS:"685",SM:"378",ST:"239",SA:"966",SN:"221",RS:"381",SC:"248",SL:"232",SG:"65",SK:"421",SI:"386",SB:"677",SO:"252",ZA:"27",SS:"211",ES:"34",LK:"94",SD:"249",SR:"597",SZ:"268",SE:"46",CH:"41",SY:"963",TW:"886",TJ:"992",TZ:"255",TH:"66",TL:"670",TG:"228",TK:"690",TO:"676",TT:"1868",TN:"216",TR:"90",TM:"993",TC:"1649",TV:"688",US:"1",UG:"256",UA:"380",AE:"971",GB:"44",
UY:"598",UZ:"998",VU:"678",VE:"58",VN:"84",VG:"1284",VI:"1340",WF:"681",EH:"212",YE:"967",ZM:"260",ZW:"263"};var OfficeAddressSubview=Backbone.View.extend({template:Templates["officeAddressProfile"],render:function(){this.$el.html(this.template(this.options));return this}});var RegistrationFormView=koreanair.View.extend({el:".registrationWrapper",events:{"keyup #userId":"changeUserID","blur #userId":"checkUserIdValidation","change #newsallagree":"setEmailDmYn","change #homeRadio, #otherRadio, #officeRadio":function(e){if($(e.currentTarget).attr("id")===
"homeRadio")$("#office-address-fields").html("");else;this.addAddressFields()},"change #country-selector":function(e){this.renderAddressBase()},"focus .dob":function(e){var $current=$(e.target);if($current.attr("placeholder")===$current.val())$current.val("")},"keydown input":function(event){var keyCode=window.event?event.which:event.keyCode;if(keyCode==$.ui.keyCode.ENTER)return false}},template:Templates["ke-registration-form"],className:".registration-form",render:function(){if(!koreanair.utils.getSessionStorage("enrollAgree")||
!!koreanair.utils.getSessionStorage("enrollAgree")&&!JSON.parse(koreanair.utils.getSessionStorage("enrollAgree")).member){window.location.hash="";return false}var data=this.model;if(!!this.model){var view=this;koreanair.countries.promise().done(function(countryList){countryList=_.sortBy(countryList,function(data){return data.text});data.countries=countryList;var html=view.template(data);view.$el.html(html);if(koreanair.isMobile){view.$el.find("select[name\x3drepresentCountryNumberCode] option:eq(0)").replaceWith("\x3coption value\x3d''\x3e"+
i18n.get("select-an-option")+"\x3c/option\x3e");view.$el.find("select[name\x3drepresentCountryNumberCode] option:eq(0)").attr("selected","selected");view.$el.find("select[name\x3dphoneNoCountryCode] option:eq(0)").replaceWith("\x3coption value\x3d''\x3e"+i18n.get("select-an-option")+"\x3c/option\x3e");view.$el.find("select[name\x3dphoneNoCountryCode] option:eq(0)").attr("selected","selected")}$("#country-selector option").eq(1).before($("\x3coption\x3e\x3c/option\x3e").val("CN").html("China"));$("#country-selector option").eq(1).before($("\x3coption\x3e\x3c/option\x3e").val("JP").html("Japan"));
$("#country-selector option").eq(1).before($("\x3coption\x3e\x3c/option\x3e").val("US").html("USA, United States of America"));$("#country-selector option").eq(1).before($("\x3coption\x3e\x3c/option\x3e").val("KR").html("Korea (the Republic of)"));if(!koreanair.isMobile){view.$el.find("input").placeholder();$("[aria-labelledby\x3dbirthdate]").find("input").trigger("placeholder:updated");koreanair.setKeSelectbox()}if(koreanair.utils.getSessionStorage("enrollAgree")){view.agrees=JSON.parse(koreanair.utils.getSessionStorage("enrollAgree"));
if(view.agrees.marketing){$("#newsallagree").prop("checked",true);if(koreanair.Country!=="kr"&&koreanair.Country!=="ca"){$("#newsEmailDmYn").prop("checked",true);$("#promoEmailDmYn").prop("checked",true)}}else{$("#newsEmailDmYn").prop("disabled",true);$("#promoEmailDmYn").prop("disabled",true)}}$("#registrationCancel").die("click").live("click",view.showLandingPage);$("#registrationSubmit").die("click").live("click",view.validateForm);$("#userIdCheck").die("click").live("click",view.checkUserID);
$('input[type\x3d"checkbox"]').die("mousedown").live("click",view.setCheckboxValue);if(koreanair.isMobile)$(".help-hint").die("click").live("click",view.showHideTooltip);koreanair.analytics.track("register_step3");if(typeof TLT!="undefined"&&TLT!=null)if(TLT&&TLT.isInitialized()&&TLT.getModuleConfig("replay").domCapture.enabled)TLT.logScreenviewLoad("#step2-inputUserInfo")});this.addAddressFields();this.setCountry()}},setCountry:function(){$("#country-selector option").each(function(){if(this.value==
koreanair.Country.toUpperCase()){$("#country-selector").val(koreanair.Country.toUpperCase());$("#country-selector").trigger("change");$('[name\x3d"representCountryNumberCode"]').val(countryPhonList[koreanair.Country.toUpperCase()])}})},renderAddressBase:function(){var addressBase=koreanair.Profile.addressBaseFactory($("#country-selector").val(),{});this.$("#address-base-wrapper").html(addressBase.render().el);if(!koreanair.isMobile)koreanair.setKeSelectbox();$("#province").die().live("change",_.bind(function(){if($("#country-selector").val()==
"US"||$("#country-selector").val()=="CA")if(koreanair.isMobile)if($("#province").val()!=""&&$("#province").val()!=i18n.get("select-an-option"))$("#postalCode").parent().parent().parent().show();else $("#postalCode").parent().parent().parent().hide();else if($("#province").val()!=""&&$("#province").val()!=i18n.get("select-an-option"))$("#postalCode").parent().parent().show();else $("#postalCode").parent().parent().hide();$("#postalCode").trigger("change")},this))},initialize:function(){_.bindAll(this)},
setEmailDmYn:function(e){if($(e.currentTarget).prop("checked"))if(koreanair.Country!=="kr"&&koreanair.Country!=="ca"){$("#newsEmailDmYn").prop("disabled",false).prop("checked",true);$("#promoEmailDmYn").prop("disabled",false).prop("checked",true)}else{$("#newsEmailDmYn").prop("disabled",false).prop("checked",false);$("#promoEmailDmYn").prop("disabled",false).prop("checked",false)}else{$("#newsEmailDmYn").prop("disabled",true).prop("checked",false);$("#promoEmailDmYn").prop("disabled",true).prop("checked",
false)}},showLegalPopup:function(e){legalPopups.showLegalPopup(e)},addAddressFields:function(){$("#office-address-fields").html((new OfficeAddressSubview(this.options)).render().el)},showLandingPage:function(e){e.preventDefault();koreanair.currentStep=koreanair.router.landingPage;koreanair.router.goTo("")},testPassword:function(value){var testExpression=/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])[0-9a-zA-Z]{8,}$/;return value.match(testExpression)},validateInput:function(e){try{if(!this.checkEl)if(koreanair.isMobile)this.checkEl=
koreanair.RegistrationValidatorMobile.getValidator($("#registration-form"));else this.checkEl=koreanair.RegistrationValidator.getValidator($("#registration-form"));var $targetEl=$(e.target);if($targetEl.attr("id")==="userIdCheck")$targetEl=$("#userId");else if(!$targetEl.attr("name"))$targetEl=$(e.target).closest(".vSpace").find("select");return this.checkEl.element($targetEl)}catch(ex){return false}},validateForm:function(e){e.preventDefault();$("#registrationSubmit").addClass("disabled");var validator=
null;if(koreanair.isMobile)validator=koreanair.RegistrationValidatorMobile;else validator=koreanair.RegistrationValidator;$("select").on("change",this.validateInput);$('input[name\x3d"addressLine1"]').die("change").live("change",this.validateInput);$('input[name\x3d"city"]').die("change").live("change",this.validateInput);$('input[name\x3d"postalCode"]').die("change").live("change",this.validateInput);var isValidForm=validator.validate($("#registration-form"));if(!isValidForm||this.duplicateId){if(isValidForm)if(this.duplicateId){var opts=
{returnFocusTo:$("#userIdCheck"),onComplete:function(){$("#cboxContent button").on("click",function(evt){evt.preventDefault();$.colorbox.close()})}};koreanair.RegistrationAlert.alertModal("\x3cp class\x3d'modal-info'\x3e"+i18n.get("IMM-id-duplication-info")+"\x3c/p\x3e"+"\x3cdiv class\x3d'btn-area t-center'\x3e\x3cbutton class\x3d'button-main-blue'\x3e"+i18n.get("ok-label")+"\x3c/button\x3e\x3c/div\x3e",opts)}$("#registrationSubmit").removeClass("disabled");return}this.submitFormData()},submitFormData:function(){var formData=
this.options.wrapper.find("form").serializeObject();formData=_.extend({},this.model,formData);var addressData=this.createAddressData(formData);var dateOfBirth=moment(formData.dateOfBirthYear+"-"+formData.dateOfBirthMonth+"-"+formData.dateOfBirthDay);var userAge=moment().diff(dateOfBirth,"years");if(userAge<14)if(formData.gender=="FEMALE")formData.title="MISS";else formData.title="MSTR";else if(formData.gender=="FEMALE")formData.title="MS";else formData.title="MR";formData.sendMailTo=formData.addressType;
formData.residenceCountry=formData.countryCode;this.password=formData.password;formData=_.omit(formData,["addressLanguage","countryCode","province","password1"]);formData.address=addressData;var enrollSkyshop=function(){return $("#skyshopTermsOfUse").is(":checked")&&$("#skyshopPrivacyPolicy").is(":checked")&&$("#skyshopThirdParty").is(":checked")};formData.cyberSkyShopEnrollYn=enrollSkyshop()?"Y":"N";formData.newsEmailDmYn=$("#newsEmailDmYn").is(":checked")?"Y":"N";formData.promoEmailDmYn=$("#promoEmailDmYn").is(":checked")?
"Y":"N";formData.smsYn=$("#smsYn").is(":checked")?"Y":"N";this.loading=this.verifyUser(formData);$(".loading-bar").fadeIn();this.loading.always(function(){$("#registrationSubmit").removeClass("disabled")});this.loading.done(_.bind(this.showConfirmationScreen,this));this.loading.fail(_.bind(this.userError,this))},verifyUser:function(userData){userData.dateOfBirth=moment(userData.dateOfBirthYear+"-"+("0"+userData.dateOfBirthMonth).slice(-2)+"-"+("0"+userData.dateOfBirthDay).slice(-2)).format("YYYY-MM-DD");
userData.passportExpirationDate=moment(userData.expYear+"-"+userData.expMonth+"-"+userData.expDay).format("YYYY-MM-DD");if(userData.passportExpirationDate==="Invalid date")delete userData.passportExpirationDate;if(userData.addressLine2==="")userData.addressLine2=" ";userData.securityQuestion="A";userData.securityResponse="undefined";userData.termsOfUse=$("#termsOfUse").is(":checked")?"Y":"N";userData.privacyPolicy=$("#privacyPolicy").is(":checked")?"Y":"N";userData.thirdPartyInfoOfferAgrYn=$("#thirdPartyInfoOfferAgrYn").is(":checked")?
"Y":"N";if(this.agrees)userData.thirdPartyInfoOfferAgrYn=this.agrees.vendor?"Y":"N";userData.memberTermsAgreeYn="Y";var ipin_skypass=this.options.model.skypassNumber;if(ipin_skypass)userData.skypassNumber=ipin_skypass;userData.currentSite=location.href.split("/").slice(0,-2).join("/");if(userData.sendMailTo=="H")userData=_.extend(userData,{homeNo:userData.phoneNo,homeNoCountryCode:userData.phoneNoCountryCode});else userData=_.extend(userData,{officeNo:userData.phoneNo,officeNoCountryCode:userData.phoneNoCountryCode});
userData=_.pick(userData,["userId","skypassNumber","password","securityQuestion","securityResponse","title","firstName","lastName","koreanLastName","koreanFirstName","dateOfBirth","gender","email","newsEmailDmYn","promoEmailDmYn","representCountryNumberCode","representPhoneNumber","smsYn","homeNoCountryCode","homeNo","officeNoCountryCode","officeNo","residenceCountry","address","sendMailTo","companyName","deptName","position","memberTermsAgreeYn","cyberSkyShopEnrollYn","thirdPartyInfoOfferAgrYn",
"emailIsoL3LanguageCode","guardianCiNo","guardianCiVersionCode","guardianLastName","guardianFirstName","memberRelationName","guardianSkypassMemberNumber","guardianEmailAddress","ciNo","ciVersionCode","currentSite"]);this.newsEmailDmYn=userData.newsEmailDmYn;this.promoEmailDmYn=userData.promoEmailDmYn;this.smsYn=userData.smsYn;userData.enrollLang=koreanair.Lang;userData.enrollCountry=koreanair.Country;userData.enrollDate=moment().format("YYYYMMDD");this.residenceCountry=userData.residenceCountry;this.skypassNumber=
userData.skypassNumber;userData.email=!!userData.email?userData.email.toLowerCase():userData.email;koreanair.fullpageLoadingScreen.show();return ServiceApi.skypassCreateMember.post({data:JSON.stringify(userData)}).always(_.bind(function(){koreanair.fullpageLoadingScreen.hide()},this))},showConfirmationScreen:function(data){var ConfirmationModel=Backbone.Model.extend({defaults:data});var ConfirmationModelInstance=new ConfirmationModel;if(koreanair.utils.getSessionStorage("enrollAgree"))koreanair.utils.clearSessionStorage("enrollAgree");
if(!this.confirmationScreen){koreanair.analytics.track("register_step4_success");this.confirmationScreen=new koreanair.RegistrationConfirmationView({model:ConfirmationModelInstance})}this.confirmationScreen.render();koreanair.router.switchViewHTML(this.confirmationScreen);window.scrollTo(0,0);if(this.confirmationScreen)if(typeof TLT!="undefined"&&TLT!=null)if(TLT&&TLT.isInitialized()&&TLT.getModuleConfig("replay").domCapture.enabled)TLT.logScreenviewLoad("#step3-registerSuccess");this.resultSkypassNumber=
data.skypassNumber;if(!koreanair.isMobile)if(true){$(".registration-landing").addClass("kr-banner");$(".promotion_banner").css("display","block")}else $(".promotion_banner").remove();if(koreanair.Country.toLowerCase()==="kr")this.alertModal(this.checkSubscribe(),this.getCoupon);else this.getCoupon();var view=this;koreanair.ServiceApi.skypassLogout.get().done(function(){koreanair.Login.callLoginService("username",data.userId,view.password).done(_.bind(function(data){if(!_.isNull(koreanair.skypass.get("passengers").user)&&
koreanair.skypass.get("passengers").user.skypassMemberStatusCode=="Sleeping"){var dormancyReleaseCompleted=new koreanair.dormancyRelease.Router;dormancyReleaseCompleted.dormancyReleaseCompleted()}koreanair.Cookie.remove("psn_adapter_s")}))}).fail(function(jqXHR){console.log(jqXHR.responseText)})},getCoupon:function(){if(this.skypassNumber)return;var allowCountry=i18n.get("imm-registration-coupon-country").toUpperCase().split(",");if(_.contains(allowCountry,this.residenceCountry)){var searchParams=
{skypassMemberNumber:this.resultSkypassNumber,country:this.residenceCountry};koreanair.ServiceApi.newMemberCoupon.post({data:JSON.stringify(searchParams),showGlobalError:false}).done(_.bind(function(){this.alertModal(i18n.get("imm-registration-coupon"))},this))}},alertModal:function(alertMsg,onCloseFunc){if(alertMsg){alertMsg='\x3cdiv class\x3d"more-info"\x3e'+alertMsg+"\x3c/div\x3e";if(koreanair.isMobile)koreanair.Modal.standardExt({templateData:alertMsg,buttonStyle:0});else koreanair.Modal.confirm(alertMsg);
if(onCloseFunc)$(document).on("cbox_closed",function(){$(document).off("cbox_closed");onCloseFunc()})}},checkSubscribe:function(){var subscribe_msg="";var now="";if(koreanair.Lang.toLowerCase()==="ko"){if(this.newsEmailDmYn=="Y")subscribe_msg+="\x3cli\x3e"+i18n.get("imm-news")+" "+i18n.get("imm-y")+"\x3c/li\x3e";else subscribe_msg+="\x3cli\x3e"+i18n.get("imm-news")+" "+i18n.get("imm-n")+"\x3c/li\x3e";if(this.promoEmailDmYn=="Y")subscribe_msg+="\x3cli\x3e"+i18n.get("imm-promotion")+" "+i18n.get("imm-y")+
"\x3c/li\x3e";else subscribe_msg+="\x3cli\x3e"+i18n.get("imm-promotion")+" "+i18n.get("imm-n")+"\x3c/li\x3e";if(this.smsYn=="Y")subscribe_msg+="\x3cli\x3e"+i18n.get("imm-sms")+" "+i18n.get("imm-y")+"\x3c/li\x3e";else subscribe_msg+="\x3cli\x3e"+i18n.get("imm-sms")+" "+i18n.get("imm-n")+"\x3c/li\x3e";now=moment().format("LL")}else{if(this.newsEmailDmYn=="Y")subscribe_msg+="\x3cli\x3e"+i18n.get("imm-y")+" "+i18n.get("imm-news")+"\x3c/li\x3e";else subscribe_msg+="\x3cli\x3e"+i18n.get("imm-n")+" "+i18n.get("imm-news")+
"\x3c/li\x3e";if(this.promoEmailDmYn=="Y")subscribe_msg+="\x3cli\x3e"+i18n.get("imm-y")+" "+i18n.get("imm-promotion")+"\x3c/li\x3e";else subscribe_msg+="\x3cli\x3e"+i18n.get("imm-n")+" "+i18n.get("imm-promotion")+"\x3c/li\x3e";if(this.smsYn=="Y")subscribe_msg+="\x3cli\x3e"+i18n.get("imm-y")+" "+i18n.get("imm-sms")+"\x3c/li\x3e";else subscribe_msg+="\x3cli\x3e"+i18n.get("imm-n")+" "+i18n.get("imm-sms")+"\x3c/li\x3e";now=moment().format("MMMM DD, YYYY")}if(subscribe_msg!=""){subscribe_msg="\x3cul\x3e"+
subscribe_msg+"\x3c/ul\x3e";subscribe_msg="\x3cp\x3e\x3cp\x3e"+i18n.get("imm-modify",now)+"\x3c/p\x3e"+subscribe_msg+"\x3c/p\x3e"}return subscribe_msg},createAddressData:function(data){var addressArray=[];var addressObject={addressLine1:cleanImmXSS(data.addressLine1),addressLine2:cleanImmXSS(data.addressLine2),addressLanguage:data.addressLanguage,addressType:data.addressType,city:data.city,province:data.province,postalCode:data.postalCode,countryCode:data.countryCode,additional:data.additional};addressArray.push(addressObject);
return addressArray},showOfficeFields:function(event){var $targetElement=$(event.target);if($targetElement.hasClass("office"))this.$el.find(".office").fadeIn();else this.$el.find(".office").fadeOut()},userError:function(jqXHR){if(!(jqXHR.responseJSON&&jqXHR.responseJSON.code))return;var code=jqXHR.responseJSON.code;var errMsg=jqXHR.responseJSON.message;var dspErrMsg;if(code==="I1003")dspErrMsg=i18n.get("already-online");else if(errMsg=="The Prefix value that you selected for Male."||errMsg=="The Prefix value that you selected for Female.")dspErrMsg=
i18n.get("gender-do-not-match");else if(code==="1012")if(/^[0-9]{12}$/.test(errMsg)){var alertMsg='\x3cp class\x3d"modal-info"\x3e'+i18n.get("imm_registerd")+"\x3c/p\x3e"+"\x3cp\x3e"+i18n.get("imm_skypass")+" "+errMsg+"\x3c/p\x3e\x3cp\x3e"+i18n.get("imm_enroll as existing member")+"\x3cbr /\x3e"+i18n.get("imm_remain the same")+"\x3c/p\x3e";if(koreanair.isMobile)koreanair.Modal.confirmExt("\x3cp\x3e"+alertMsg+" \x3c/p\x3e").done(_.bind(function(){$("input[name\x3dskypassNumber]").val(errMsg);$("#registrationSubmit").trigger("click")},
this));else{var opts={ariaLabel:"Warning",onComplete:function(){$("#spCancel, #spOk").on("click",function(e){e.preventDefault();$.colorbox.close();$("#colorbox").off();if($(e.currentTarget).attr("id")==="spOk"){$("input[name\x3dskypassNumber]").val(errMsg);$("#registrationSubmit").trigger("click")}})}};koreanair.Modal.confirm('\x3cdiv class\x3d"checkin confirm"\x3e \x3cp\x3e'+alertMsg+' \x3c/p\x3e \x3cdiv class\x3d"button-group-center"\x3e \x3cbutton id\x3d"spCancel" class\x3d"button-main-gray"\x3e'+
i18n.get("Cancel")+'\x3c/button\x3e \x3cbutton id\x3d"spOk" class\x3d"button-main-blue"\x3e'+i18n.get("Confirm")+"\x3c/button\x3e\x3c/div\x3e\x3c/div\x3e",opts)}}else dspErrMsg=i18n.get("skypass-already-registered");else dspErrMsg=i18n.get("registration-failed");$("#error-wrapper").text(dspErrMsg);if(code!=="1012"){koreanair.analytics.prop({"register_error_message":errMsg}).track("register_error_call");koreanair.analytics.track("register_step3");if(typeof TLT!="undefined"&&TLT!=null)if(TLT&&TLT.isInitialized()&&
TLT.getModuleConfig("replay").domCapture.enabled)TLT.logScreenviewLoad("#step3-registerFail")}},showHideTooltip:function(e){e.preventDefault();if($(".hint-tooltip").css("display")=="block"){$(".help-hint").switchClass("show","hide");$(".hint-tooltip").hide()}else{$(".help-hint").switchClass("hide","show");$(".hint-tooltip").show()}},setCheckboxValue:function(event){var $targetElement=$(event.target);if(!$targetElement.is(":checked"))$targetElement.next().val("Y");else $targetElement.next().val("N")},
switchViewHTML:function(view){var html=view.$el.html();this.$el.html(html);this.currentStep=view},changeUserID:function(e){this.duplicateId=true;$("#uniqueUserID").text("").removeAttr("data-errored-element style")},checkUserIdValidation:function(e){e.preventDefault();$("#userId").removeAttr("aria-describedby aria-invalid");if(!this.validateInput(e)){$("#uniqueUserID").text("").removeAttr("data-errored-element style");return}},checkUserID:function(e){e.preventDefault();this.duplicateId=true;$("#uniqueUserID").text("").removeAttr("data-errored-element style");
$("#userId").removeAttr("aria-describedby aria-invalid");if($("#userId").val()===""){$("#uniqueUserID").text("");return}if(!this.validateInput(e)){$("#uniqueUserID").text("");return}koreanair.ServiceApi.checkDuplicateID.post({data:JSON.stringify({"userId":$("#userId").val().toUpperCase()}),success:function(data){setTimeout(function(){this.duplicateId=true;$("#uniqueUserID").css("color","rgb(212, 42, 29)").html("\x3cspan\x3e"+i18n.get("imm-check-id-unavailable")+"\x3c/span\x3e").attr({"data-errored-element":"userId"});
$("#userId").attr({"aria-invalid":true,"aria-describedby":"uniqueUserID"}).focus()},300)}.bind(this),error:function(jqXHR,textStatus){this.duplicateId=false;$("#uniqueUserID").css("color","rgb(69, 134, 0)").html("\x3cspan\x3e"+i18n.get("imm-check-id-available")+"\x3c/span\x3e")}.bind(this)})},initPostalCode:function(e){},checkPostalCode:_.throttle(function(e){},100,{leading:true})});koreanair.RegistrationFormView=RegistrationFormView})(_,Backbone,koreanair,koreanair.ServiceApi,koreanair.Booking,Handlebars.templates,
Granite.I18n,koreanair.utils.legalPopups);
